# Pipeline Definition（一本の道）

## 目的

このファイルは、**容量管理型タスクスケジューラー**の処理フローを**1本の道**として定義します。

---

## 統一汎用パイプラインとは

**定義**: 全ての処理が共通のプロセス Phase ① → Phase ② → ... → Phase ⑨ を選択的に使用する単一のパイプライン。

### 誤った理解（❌）
```
タスク配置パイプライン（200行）
テンプレート管理パイプライン（150行）← 80%が重複！
時間枠管理パイプライン（150行）← 80%が重複！
完了処理パイプライン（100行）← 90%が重複！
```

### 正しい理解（✅）
```
Phase ① → Phase ② → ... → Phase ⑨
          ↓       ↓           ↓
   全ての操作が共通のパイプラインを使用
   （違いは「トリガー」だけ）
```

---

## パイプライン構造（9段階）

### Phase ① 入力解析（受付係）
**目的**: ユーザーコマンドの解析

**処理内容**:
- コマンド文字列の受け取り
- コマンド形式の検証
- コマンドとパラメータの分離

**入力**: 生のコマンド文字列
**出力**: 解析済みコマンドデータ

**例**:
- "place ミーティング 9:00" → action="place", template="ミーティング", slot="9:00"
- "create_template ミーティング 30" → action="create_template", name="ミーティング", weight=30
- "create_slot 9:00 60" → action="create_slot", time="9:00", capacity=60
- "complete 1" → action="complete", task_id=1
- "list" → action="list"

**実装場所**: `src/controllers/input_parser.py`

**職務分掌**: 
- ✅ 伝達するが処理はしない
- ❌ 提案を出してはいけない
- ❌ データを書き込んではいけない

---

### Phase ② トリガー検出
**目的**: どの部署を呼ぶべきか判断

**処理内容**:
- actionに基づいてトリガーを特定
- 呼び出すべき提案部署を決定
- 不正なコマンドを検出

**入力**: 解析済みコマンドデータ
**出力**: トリガー情報（部署のリスト）

**トリガーマッピング**:
- "place" → TaskPlacementProposer
- "create_template" → TaskTemplateManager
- "create_slot" → TimeSlotManager
- "complete" → TaskCompletionHandler
- "list" → DisplayHandler

**実装場所**: `src/controllers/trigger_detector.py`

**職務分掌**:
- ✅ 判断するが実行はしない
- ❌ データを変更してはいけない

---

### Phase ③ 提案部署招集
**目的**: 検出されたトリガーに基づいて提案部署を呼び出す

**処理内容**:
- Phase ② で検出されたトリガーに基づいて提案部署を招集
- 各部署に処理を依頼
- Claim（提案）を収集

**入力**: トリガー情報、解析済みコマンドデータ
**出力**: Claim一覧（提案内容）

**招集される部署**:
- TaskPlacementProposer（タスク配置提案）
- TaskTemplateManager（テンプレート管理提案）
- TimeSlotManager（時間枠管理提案）
- TaskCompletionHandler（完了処理提案）
- DisplayHandler（表示のみ、Claimなし）

**重要な原則**:
- ❌ 検出されていない操作の部署を呼ばない
- ✅ 必要な部署だけを呼ぶ（効率化）
- ❌ この段階ではデータを書き込まない（提案のみ）

**実装場所**: `src/controllers/handler_invoker.py`

---

### Phase ④ 検証部署招集
**目的**: 提案の妥当性を複数の観点から検証

**処理内容**:
- CapacityValidator（容量検証部署）を招集
- ConsistencyValidator（整合性検証部署）を招集
- 各検証結果を収集

**入力**: Claim一覧
**出力**: 検証結果一覧

**招集される部署**:
- **CapacityValidator**: 容量計算（入るか？残り容量は？）
- **ConsistencyValidator**: 整合性確認（ID重複？枠存在？テンプレート有効？）

**重要な相互牽制**:
- ✅ 容量検証部署は配置しない
- ✅ 整合性検証部署は容量を見ない
- ❌ 検証部署は承認・却下を決定しない

**実装場所**: `src/controllers/validator_invoker.py`

---

### Phase ⑤ 検証結果の評価
**目的**: 全ての検証結果を統合し、OK/NGを判定

**処理内容**:
- 容量検証結果の確認
- 整合性検証結果の確認
- 総合判定（全て○なら次へ、1つでも×なら分岐）

**入力**: 検証結果一覧
**出力**: 総合判定結果

**判定ロジック**:
```
IF 容量検証 == OK AND 整合性検証 == OK:
    → Phase ⑦ へ（中央管理機関の承認）
ELSE IF 容量検証 == NG:
    → Phase ⑥ へ（自動再配置）
ELSE:
    → Phase ⑨ へ（エラー出力）
```

**実装場所**: `src/controllers/claim_arbiter.py` 内の評価ロジック

---

### Phase ⑥ 容量オーバー時の自動再配置提案
**目的**: 容量オーバー時のみ、代替案を提案

**処理内容**:
- AutoReplacementProposer（自動再配置提案部署）を招集
- 次の時間枠を検索
- 最初の空き枠を検索
- 代替配置先の提案（Claim）を出す

**入力**: 元の配置提案、容量検証NG結果
**出力**: 代替配置提案（Claim）

**重要な原則**:
- ✅ Phase ⑤で容量NGの場合のみ動作
- ❌ 実際にタスクを移動してはいけない（提案のみ）
- ❌ どの代替案を採用するか決定してはいけない

**実装場所**: `src/handlers/auto_replacement_proposer.py`

**Phase ⑥の後**:
- 代替提案が出たら Phase ④ に戻る（再検証）
- 代替案がなければ Phase ⑨ へ（エラー出力）

---

### Phase ⑦ 中央管理機関の最終決裁
**目的**: 全部署の提案と検証結果を集約し、最終決定

**処理内容**:
- 全てのClaimを受け取る
- 全ての検証結果を確認
- 職務分掌違反のチェック
- 最終承認 or 却下

**入力**: 
- Claim一覧（提案部署からの提案）
- 検証結果一覧（検証部署からの判定）

**出力**: 最終決定（承認 or 却下）

**決裁ルール**:
```
IF 全ての検証が○ AND 職務分掌違反なし:
    → 承認（Phase ⑧ へ）
ELSE:
    → 却下（Phase ⑨ へ）
```

**重要な権限**:
- ✅ **唯一データを書き込める部署**
- ✅ 全部署を監視する
- ✅ 最終決定権を持つ

**実装場所**: `src/controllers/central_layer_claim_arbiter.py`

---

### Phase ⑧ 実行とデータ書き込み
**目的**: 承認された処理を実際に実行

**処理内容**:
- Phase ⑦で承認された内容をデータに反映
- タスク配置、テンプレート作成、時間枠作成、完了マークなど
- トランザクション管理（失敗時のロールバック）

**入力**: 承認された最終決定
**出力**: 実行結果

**重要な原則**:
- ✅ Phase ⑦の承認がなければ実行されない
- ✅ 中央管理機関の指示のみに従う

**実装場所**: `src/models/task_repository.py`, `src/models/data_store.py`

---

### Phase ⑨ 結果出力
**目的**: 処理結果をユーザーに返す

**処理内容**:
- 成功メッセージの整形
- エラーメッセージの整形
- 一覧表示のフォーマット

**入力**: 実行結果 or エラー情報
**出力**: ユーザーへのメッセージ

**出力例**:
```
成功: "タスク「ミーティング」を9:00に配置しました（残り容量: 30）"
容量オーバー: "9:00は容量不足です。10:00に自動配置しました"
エラー: "テンプレート「会議」が存在しません"
一覧: "9:00 [30/60] ミーティング(30)\n10:00 [0/60] (空き)"
```

**実装場所**: `src/views/result_formatter.py`

---

## データフロー図（全体像）

```
[ユーザーコマンド]
      ↓
Phase ① 入力解析（受付係）
      ↓
Phase ② トリガー検出
      ↓
Phase ③ 提案部署招集 ──→ Claim収集
      ↓
Phase ④ 検証部署招集 ──→ 検証結果収集
      ↓
Phase ⑤ 検証結果の評価
      ↓         ↓（容量NG）
      |    Phase ⑥ 自動再配置提案
      |         ↓
      |    （Phase ④ に戻る）
      ↓（全て○）
Phase ⑦ 中央管理機関の最終決裁
      ↓（承認）
Phase ⑧ 実行とデータ書き込み
      ↓
Phase ⑨ 結果出力
      ↓
[ユーザーへ表示]
```

---

## 部署の職務分掌まとめ

### 【提案系】
| 部署 | できること | できないこと |
|------|-----------|-------------|
| TaskPlacementProposer | タスク配置の提案 | 容量チェック、実際の配置、承認 |
| TaskTemplateManager | テンプレート管理の提案 | タスク配置、時間枠操作 |
| TimeSlotManager | 時間枠管理の提案 | タスク配置、容量計算 |
| TaskCompletionHandler | 完了状態変更の提案 | 内容変更、削除、時間枠操作 |
| AutoReplacementProposer | 代替配置先の提案 | 実際の移動、採用決定 |

### 【検証系】
| 部署 | できること | できないこと |
|------|-----------|-------------|
| CapacityValidator | 容量計算、判定 | 配置決定、ルールチェック |
| ConsistencyValidator | 整合性チェック | 容量計算、配置決定 |

### 【表示系】
| 部署 | できること | できないこと |
|------|-----------|-------------|
| DisplayHandler | データ取得、表示 | データ変更、Claim提出 |

### 【中央管理機関】
| 部署 | できること | 唯一の権限 |
|------|-----------|-----------|
| CentralLayerClaimArbiter | 全Claim集約、検証確認、職務分掌監視 | **唯一データを書き込める** |

---

## 相互牽制のポイント

1. **提案部署は実行しない**
   - TaskPlacementProposer は「入れたい」と提案するだけ
   - 実際に入れるのは Phase ⑧

2. **検証部署は決定しない**
   - CapacityValidator は「入る/入らない」を判定するだけ
   - ConsistencyValidator は「OK/NG」を判定するだけ
   - 最終決定は Phase ⑦ の中央管理機関

3. **中央管理機関だけが書き込める**
   - 全部署が○を出しても、中央管理機関が承認しなければ実行されない
   - 職務分掌違反があれば即座に却下

4. **容量オーバー時も同じルート**
   - 自動再配置も「提案」にすぎない
   - Phase ④ で再検証され、Phase ⑦ で承認される

---

## governance_gate.py での使用

このファイルは `governance_gate.py` の Layer 2（動的フロー検証）で使用されます。

**検証内容**:
- ✅ Phase ① → Phase ② → ... の順序が守られているか
- ✅ Phase をスキップしていないか（ショートカットなし）
- ✅ Phase ⑥から Phase ④ への戻りが正しく実装されているか
- ✅ Phase ⑦を経ずに Phase ⑧ へ進んでいないか

---

## まとめ

**この「一本の道」を守ることで**:
- ✅ 処理の流れが一貫する
- ✅ 複数の操作が1本のパイプラインに統合される
- ✅ バグが特定しやすい
- ✅ 新機能の追加が容易
- ✅ AIが設計を守りながら開発できる

**AIへの最重要指示**:
あなたが新しい機能を実装する際は、必ずこのファイルを読んで「どのPhaseに組み込むべきか」を判断してください。新しいパイプラインを作らず、この1本の道に統合してください。
